/*
 * Copyright (c) 2021-2025, RTduino Development Team
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 * https://github.com/RTduino/RTduino
 * https://gitee.com/rtduino/RTduino
 *
 * Change Logs:
 * Date           Author       Notes
 * 2025-01-05     Meco Man     first version
 */

#include <RTduino.h>
#include <utest.h>

# define PATTERN_SIZE	15

struct dtostrf_s {
    union {
        long lo;
        float fl;
    };
    signed char width;
    unsigned char prec;
    char pattern[PATTERN_SIZE];
};

#define	PZLEN	5	/* protected zone length	*/

static void run_dtostrf(const struct dtostrf_s *pt, int testno)
{
    union {
        long lo;
        float fl;
    } val;

    signed char width;
    unsigned char prec;
    static char s[2*PZLEN + sizeof(pt->pattern)];
    char c, *ps;
    char const *pp;
    
    rt_memset (s, testno, sizeof(s));

    val.lo = pt->lo;
    width  = pt->width;
    prec   = pt->prec;

    ps = dtostrf (val.fl, width, prec, s + PZLEN);
    uassert_ptr_equal(ps, s + PZLEN);

    for (ps = s; ps != s + PZLEN; ps++) {
        uassert_int_equal((unsigned char)*ps, testno & 0377);
    }

    pp = pt->pattern;
    do {
        c = *pp++;
        if (*ps++ != c)
        {
            LOG_E("*** testno= %d:  must= %s  was= %s\n",
                testno, pt->pattern, s + PZLEN);
            uassert_true(0);
        }
    } while (c);

    for (; ps != s + sizeof(s); ps++)
    {
        uassert_int_equal((unsigned char)*ps, testno & 0377);
    }
}

static const struct dtostrf_s basic_table[] = {

    /* Nonregular cases.	*/
    { { .fl = 1.0 }, 0, 0,	"1" },
    { { .fl = 0.0 }, 0, 0,	"0" },
    { { .fl = 1.1 }, 0, 1,	"1.1" },
    { { .fl = 1.2 }, 4, 1,	" 1.2" },
    { { .fl = 0.5 }, 0, 1,	"0.5" },
    { { .fl = 0.5 }, 0, 2,	"0.50" },
    { { .fl = 0.5 }, 0, 8,	"0.50000000" },
    { { .fl = 0.5 }, 0, 9,	"0.500000000" },
    { { .fl = 123.45 }, 0, 2,	"123.45" },
    { { .fl = 0.999999 }, 0, 6,	"0.999999"	},
    
    { { .fl = 1.234 }, -8, 3,	"1.234   "	},
    { { .fl = -1.234 }, -8, 3,	"-1.234  "	},

};

static const struct dtostrf_s big_table[] = {

    { { .fl = 1.2345678 }, 127, 7,
	"                                "	/* 32 */
	"                                "	/* 32 */
	"                                "	/* 32 */
	"                      1.2345678" },

    { { .fl = 1.2345678 }, -128, 7,
	"1.2345678                       "	/* 32 */
	"                                "	/* 32 */
	"                                "	/* 32 */
	"                                " },

    { { .fl = -1.2345678 }, 127, 7,
	"                                "	/* 32 */
	"                                "	/* 32 */
	"                                "	/* 32 */
	"                     -1.2345678" },

    { { .fl = -1.2345678 }, -128, 7,
	"-1.2345678                      "	/* 32 */
	"                                "	/* 32 */
	"                                "	/* 32 */
	"                                " },

    { { .fl = 12345678. }, 0, 255,
	"12345678."
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"0000000000000000000000000000000" },

    { { .fl = -12345678. }, 0, 255,
	"-12345678."
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"0000000000000000000000000000000" },

    { { .fl = .5 }, 0, 255,
	"0."
	"50000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"00000000000000000000000000000000"	/* 32 */
	"0000000000000000000000000000000" },
};

static const struct dtostrf_s minmax_table[] = {

    { { 0x00800000 }, 0, 45,
	"0.000000000000000000000000000000000000011754944"	},
    { { 0x00800000 }, 0, 44,
	"0.00000000000000000000000000000000000001175494"	},
    { { 0x00800000 }, 0, 43,
	"0.0000000000000000000000000000000000000117549"	},
    { { 0x00800000 }, 0, 42,
	"0.000000000000000000000000000000000000011755"	},
    { { 0x00800000 }, 0, 41,
	"0.00000000000000000000000000000000000001175"	},
    { { 0x00800000 }, 0, 40,
	"0.0000000000000000000000000000000000000118"	},
    { { 0x00800000 }, 0, 39,
	"0.000000000000000000000000000000000000012"	},
    { { 0x00800000 }, 0, 38,
	"0.00000000000000000000000000000000000001"	},
    { { 0x00800000 }, 0, 37,
	"0.0000000000000000000000000000000000000"	},
    { { 0x00800000 }, 0, 36,
	"0.000000000000000000000000000000000000"	},

    { { 0x80800000 }, 0, 45,
	"-0.000000000000000000000000000000000000011754944"	},
    { { 0x00800000 }, 49, 45,
	"  0.000000000000000000000000000000000000011754944"	},
    { { 0x80800000 }, 49, 45,
	" -0.000000000000000000000000000000000000011754944"	},
};

static const struct dtostrf_s nans_table[] = {

    { { 0x7f800000 }, 0, 0,	"INF"		},
    { { 0x7f800000 }, 10, 0,	"       INF"	},
    { { 0x7f800000 }, -10, 0,	"INF       "	},

    { { 0x7f800000 }, 0, 1,	"INF"		},
    { { 0x7f800000 }, 0, 255,	"INF"		},
    { { 0x7f800000 }, 4, 2,	" INF"		},

    { { 0xff800000 }, 0, 0,	"-INF"		},
    { { 0xff800000 }, 10, 0,	"      -INF"	},
    { { 0xff800000 }, -10, 0,	"-INF      "	},

    { { 0x7f800001 }, 0, 0,	"NAN"		},
    { { 0x7f800001 }, 10, 0,	"       NAN"	},
    { { 0x7f800001 }, -10, 0,	"NAN       "	},

    { { 0xff800001 }, 0, 0,	"NAN"		},    /* no '-NaN' */
    { { 0xff800001 }, 10, 0,	"       NAN"	},
    { { 0xff800001 }, -10, 0,	"NAN       "	},

    { { 0x7fffffff }, 0, 0,	"NAN" },
    { { 0xffffffff }, 0, 0,	"NAN" },
    { { 0x7fc00000 }, 0, 0,	"NAN" },
    { { 0xffc00000 }, 0, 0,	"NAN" },

    { { 0x7fc00000 }, 0, 1,	"NAN" },
    { { 0x7fc00000 }, 0, 255,	"NAN" },
    { { 0x7fc00000 }, 4, 2,	" NAN" },
};

static const struct dtostrf_s round_table[] = {

    { { .fl = .46 }, 0, 3,	"0.460"	},
    { { .fl = .46 }, 0, 2,	"0.46"	},
    { { .fl = .46 }, 0, 1,	"0.5"	},
    { { .fl = .46 }, 0, 0,	"0"	}, /* just that very case */
    { { .fl = .46 }, 1, 0,	"0"	},
    { { .fl = .46 }, 2, 0,	" 0"	},

    { { .fl = .51 }, 0, 3,	"0.510"	},
    { { .fl = .51 }, 0, 2,	"0.51"	},
    { { .fl = .51 }, 0, 1,	"0.5"	},
    { { .fl = .51 }, 0, 0,	"1"	},
    { { .fl = .51 }, 1, 0,	"1"	},
    { { .fl = .51 }, 2, 0,	" 1"	},

    { { .fl = .58 }, 0, 3,	"0.580"	},
    { { .fl = .58 }, 0, 2,	"0.58"	},
    { { .fl = .58 }, 0, 1,	"0.6"	},
    { { .fl = .58 }, 0, 0,	"1"	},
    { { .fl = .58 }, 1, 0,	"1"	},
    { { .fl = .58 }, 2, 0,	" 1"	},
    
    { { .fl = 0.4999 }, 0, 4,	"0.4999"},
    { { .fl = 0.4999 }, 0, 3,	"0.500"	},
    { { .fl = 0.4999 }, 0, 2,	"0.50"	},
    { { .fl = 0.4999 }, 0, 1,	"0.5"	},
    { { .fl = 0.4999 }, 0, 0,	"0"	},

    { { .fl = 0.049 }, 0, 2,	"0.05"	},
    { { .fl = 0.049 }, 0, 1,	"0.0"	},
    { { .fl = 0.049 }, 0, 0,	"0"	},

    { { .fl = 0.0000000000049 }, 0, 12,	"0.000000000005"},
    { { .fl = 0.0000000000049 }, 0, 11,	"0.00000000000"	},
    { { .fl = 0.0000000000049 }, 0, 10,	"0.0000000000"	},
    
    { { .fl = 0.0000000000051 }, 0, 12,	"0.000000000005"},
    { { .fl = 0.0000000000051 }, 0, 11,	"0.00000000001"	},
    { { .fl = 0.0000000000051 }, 0, 10,	"0.0000000000"	},
    
};

static const struct dtostrf_s width_table[] = {

    { { .fl = .123 }, 0, 3,	"0.123" },
    { { .fl = .123 }, 1, 3,	"0.123" },
    { { .fl = .123 }, 5, 3,	"0.123" },
    { { .fl = .123 }, 6, 3,	" 0.123" },
    { { .fl = .123 }, 10, 3,	"     0.123" },
    { { .fl = -.123 }, 10, 3,	"    -0.123" },
    
    { { .fl = 123.45 }, 0, 2,	"123.45" },
    { { .fl = 123.45 }, 1, 2,	"123.45" },
    { { .fl = 123.45 }, 6, 2,	"123.45" },
    { { .fl = 123.45 }, 7, 2,	" 123.45" },
    { { .fl = 123.45 }, 10, 2,	"    123.45" },
    { { .fl = -123.45 }, 10, 2,	"   -123.45" },

    { { .fl = 10. }, 0, 0,	"10" },
    { { .fl = 10. }, 1, 0,	"10" },
    { { .fl = 10. }, 2, 0,	"10" },
    { { .fl = 10. }, 3, 0,	" 10" },
    { { .fl = 10. }, 10, 0,	"        10" },
    { { .fl = -10. }, 10, 0,	"       -10" },

    { { .fl = .123 }, -1, 3,	"0.123" },
    { { .fl = 123.45 }, -1, 2,	"123.45" },
    { { .fl = 10. }, -1, 0,	"10" },

    { { .fl = .123 }, -10, 3,	"0.123     " },
    { { .fl = -.123 }, -10, 3,	"-0.123    " },
    { { .fl = 123.45 }, -10, 2,	"123.45    " },
    { { .fl = -123.45 }, -10, 2,"-123.45   " },
    { { .fl = 10. }, -10, 0,	"10        " },
    { { .fl = -10. }, -10, 0,	"-10       " },
};

#define TC_dtostrf_entry(name) \
    static void TC_dtostrf_##name() \
    { \
        for (int i= 0; (size_t)i != sizeof(name##_table)/sizeof(name##_table[0]); i++) \
            run_dtostrf (name##_table+i, i+1); \
    }

#define TC_dtostrf_run(name)   UTEST_UNIT_RUN(TC_dtostrf_##name) 

/* utest cases */
TC_dtostrf_entry(basic)
TC_dtostrf_entry(big)
TC_dtostrf_entry(minmax)
TC_dtostrf_entry(nans)
TC_dtostrf_entry(round)
TC_dtostrf_entry(width)

/* Utest function to run all test cases */
static void utest_do_tc(void)
{
    TC_dtostrf_run(basic);
    // TC_dtostrf_run(big);
    // TC_dtostrf_run(minmax);
    // TC_dtostrf_run(nans);
    TC_dtostrf_run(round);
    TC_dtostrf_run(width);
}

UTEST_TC_EXPORT(utest_do_tc, "RTduino.core.dtostrf", RT_NULL, RT_NULL, 1000);
